import Tabs from '@theme/Tabs'
import TabItem from '@theme/TabItem'

<Tabs groupId="version">
<TabItem value="one-click-auth" label="One-Click Auth">

```ts
import { SiweMessage } from 'siwe'
import {
  type SIWESession,
  type SIWEVerifyMessageArgs,
  type SIWECreateMessageArgs,
  createSIWEConfig,
  formatMessage
} from '@web3modal/siwe'

const BASE_URL = 'http://localhost:8080'

/* Function that returns the user's session - this should come from your SIWE backend */
async function getSession() {
  const res = await fetch(BASE_URL + '/session', {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json'
    },
    credentials: 'include'
  })
  if (!res.ok) {
    throw new Error('Network response was not ok')
  }

  const data = await res.json()
  return data == '{}' ? null : (data as SIWESession)
}

/* Use your SIWE server to verify if the message and the signature are valid */
const verifyMessage = async ({ message, signature }: SIWEVerifyMessageArgs) => {
  try {
    const response = await fetch(BASE_URL + '/verify', {
      method: 'POST',
      headers: {
        Accept: 'application/json',
        'Content-Type': 'application/json'
      },
      mode: 'cors',
      body: JSON.stringify({ message, signature }),
      credentials: 'include'
    })

    if (!response.ok) {
      return false
    }

    const result = await response.json()
    return result === true
  } catch (error) {
    return false
  }
}

// Check the full example for signOut and getNonce functions ...

/* Create a SIWE configuration object */
const siweConfig = createSIWEConfig({
  getMessageParams: async () => ({
    domain: window.location.host,
    uri: window.location.origin,
    chains: [1, 2020],
    statement: 'Please sign with your account'
  }),
  createMessage: ({ address, ...args }: SIWECreateMessageArgs) => formatMessage(args, address),
  getNonce,
  getSession,
  verifyMessage,
  signOut
})
```

## Server Side

Setting up a backend server using Express for a web application that interacts with the Siwe protocol.

### Routes:

- GET '/nonce': Generates and returns a nonce (single-use random number).
- POST '/verify': Uses the Siwe protocol to verify the message, requiring a signature (the one you are going to approve throw the UX) and a nonce stored in the session.
- GET '/session': Retrieves the stored Siwe object from the session.
- GET '/signout': Clears the session.

```ts
import cors from 'cors'
import express from 'express'
import Session from 'express-session'
import { generateNonce, SiweMessage } from 'siwe'

const app = express()

// configure cors and sessions
app.use(
  cors({
    origin: 'http://localhost:5173', // frontend URL
    credentials: true
  })
)
app.use(express.json())
app.use(
  Session({
    name: 'siwe-quickstart',
    secret: 'siwe-quickstart-secret',
    resave: true,
    saveUninitialized: true,
    cookie: { secure: false, sameSite: true }
  })
)

app.get('/nonce', function (_, res) {
  res.setHeader('Content-Type', 'text/plain')
  console.log('/nonce')
  res.send(generateNonce())
})

// verify the message
app.post('/verify', async (req, res) => {
  try {
    if (!req.body.message) {
      return res.status(400).json({ error: 'SiweMessage is undefined' })
    }
    let SIWEObject = new SiweMessage(req.body.message)
    const { data: message } = await SIWEObject.verify({
      signature: req.body.signature,
      nonce: req.session.nonce
    })

    const address = message.address
    const chainId = message.chainId

    // save the session with the address and chainId (SIWESession)
    req.session.siwe = { address, chainId }
    req.session.save(() => res.status(200).send(true))
  } catch (e) {
    // clean the session
    req.session.siwe = null
    req.session.nonce = null
    req.session.save(() => res.status(500).json({ message: e.message }))
  }
})

/// ... check the github repository for the others endpoints

// get the session
app.get('/session', (req, res) => {
  res.setHeader('Content-Type', 'application/json')
  res.send(req.session.siwe)
})
```

Check the github full example to see the full flow working: [siwe-quickstart](https://github.com/WalletConnect/web-examples/tree/main/dapps/appkit-siwe/react/)

### `verifySignature`

Verify a SIWE signature.

```ts
import { verifySignature } from '@web3modal/siwe'

const isValid = await verifySignature({ address, message, signature, chainId, projectId })
```

</TabItem>
<TabItem value="legacy" label="Legacy">

With help of the [siwe package](https://docs.login.xyz/sign-in-with-ethereum/quickstart-guide/implement-the-frontend) we will create the required configuration for Web3Modal.

:::note
The nonce and verification process will be implemented in your backend. [Read more.](https://docs.login.xyz/sign-in-with-ethereum/quickstart-guide/implement-the-backend)
:::

```ts
import { SiweMessage } from 'siwe'
import { createSIWEConfig } from '@web3modal/siwe'
import type { SIWECreateMessageArgs, SIWEVerifyMessageArgs } from '@web3modal/siwe'

/* Function that creates a SIWE message */
function createMessage({ nonce, address, chainId }: SIWECreateMessageArgs){
  const message = new SiweMessage({
    version: '1',
    domain: window.location.host,
    uri: window.location.origin,
    address,
    chainId,
    nonce,
    statement: 'Sign in With Ethereum.'
  })

  return message.prepareMessage()
}

/* Function that returns the user's session */
async function getSession(){
  //...
}

/* Use your SIWE server to verify if the message and the signature are valid */
async function verifyMessage({ message, signature }: SIWEVerifyMessageArgs){
  try {
    const isValid = await validateMessage({ message, signature })

    return isValid
  } catch (error) {
    return false
  }
},

/* Create a SIWE configuration object */
const siweConfig = createSIWEConfig({
  createMessage,
  getNonce,
  getSession,
  verifyMessage,
  signOut
})
```

</TabItem>
</Tabs>
